// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// =============================================
// 用户模型
// =============================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String?  // bcrypt加密后的密码 (Apple登录用户可为空)
  name      String?
  avatar    String?
  country   String?  // 用户国家/地区代码 (ISO 3166-1 alpha-2)

  // Apple Sign In 字段
  appleId   String?  @unique @map("apple_id") // Apple 用户唯一标识 (sub)
  authType  String   @default("email") @map("auth_type") // "email" | "apple"

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // 默认支出账户设置 (全局只有一个)
  defaultExpenseAccountId   String? @map("default_expense_account_id")   // 账户或信用卡的 ID
  defaultExpenseAccountType String? @map("default_expense_account_type") // "ACCOUNT" 或 "CREDIT_CARD"

  // 默认收入账户设置（收入只能进入账户，不能进入信用卡）
  defaultIncomeAccountId   String? @map("default_income_account_id")
  defaultIncomeAccountType String? @map("default_income_account_type") // 目前只支持 "ACCOUNT"

  // 关联关系
  accounts    Account[]
  records     Record[]
  budgets     Budget[]
  categories  Category[]
  creditCards CreditCard[]
  creditCardTransactions CreditCardTransaction[]
  autoPayments AutoPayment[]
  autoIncomes AutoIncome[]
  subscription Subscription?

  @@map("users")
}

// =============================================
// 用户订阅模型
// =============================================
model Subscription {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")

  // 订阅状态: TRIAL(试用), ACTIVE(有效), EXPIRED(过期), CANCELLED(取消)
  status          String   @default("NONE")

  // 订阅计划: MONTHLY(月度), YEARLY(年度)
  plan            String?

  // Apple 交易信息
  appleProductId  String?  @map("apple_product_id")
  appleTransactionId String? @map("apple_transaction_id")

  // 时间信息
  trialStartDate  DateTime? @map("trial_start_date")
  trialEndDate    DateTime? @map("trial_end_date")
  subscriptionStartDate DateTime? @map("subscription_start_date")
  subscriptionEndDate   DateTime? @map("subscription_end_date")

  // 自动续费
  autoRenew       Boolean  @default(true) @map("auto_renew")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // 关联
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// =============================================
// 账户模型
// =============================================
model Account {
  id        String      @id @default(uuid())
  name      String      // 账户名称,例如:招商银行、支付宝
  type      String      // 账户类型: BANK, INVESTMENT, CASH, CREDIT_CARD
  balance   Float     @default(0) // 当前余额(信用卡为负=欠款)
  currency  String      @default("CNY")
  userId    String      @map("user_id")
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")
  
  // 贷款专用字段 (type = LOAN 或 MORTGAGE 时使用)
  loanTermMonths    Int?     @map("loan_term_months")    // 贷款期限(月)
  interestRate      Float?   @map("interest_rate")       // 年利率 (%)
  monthlyPayment    Float?   @map("monthly_payment")     // 月供金额
  repaymentDay      Int?     @map("repayment_day")       // 还款日 (每月几号, 1-28)
  loanStartDate     DateTime? @map("loan_start_date")    // 贷款开始日期
  institutionName   String?  @map("institution_name")    // 贷款机构名称

  // 关联关系
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceRecords  Record[] @relation("SourceAccount") // 作为源账户的记录
  targetRecords  Record[] @relation("TargetAccount") // 作为目标账户的记录
  autoPaymentsAsTarget AutoPayment[] @relation("PaymentTarget") // 作为还款目标
  autoPaymentSources AutoPaymentSource[] @relation("AutoPaymentSources") // 作为自动扣款来源
  autoIncomes    AutoIncome[] @relation("IncomeTarget") // 作为自动入账目标

  @@index([userId])
  @@map("accounts")
}

// 账户类型常量 (SQLite不支持enum,使用String)
// BANK = 银行卡
// INVESTMENT = 投资账户
// CASH = 现金
// CREDIT_CARD = 信用卡
// DIGITAL_WALLET = 电子钱包
// LOAN = 贷款
// MORTGAGE = 房贷
// SAVINGS = 储蓄账户
// RETIREMENT = 养老金
// CRYPTO = 加密货币
// PROPERTY = 房产
// VEHICLE = 车辆
// OTHER_ASSET = 其他资产
// OTHER_LIABILITY = 其他负债

// =============================================
// 记账记录模型
// =============================================
model Record {
  id          String     @id @default(uuid())
  amount      Float    // 金额
  type        String     // 记账类型: EXPENSE, INCOME, TRANSFER, INVEST_BUY, INVEST_SELL, REPAYMENT
  category    String     // 分类名称
  description String?    // 备注
  rawText     String?    @map("raw_text") // AI语音原始文本
  date        DateTime   @default(now()) // 记账日期
  accountId   String?    @map("account_id") // 可选，信用卡消费无普通账户
  userId      String     @map("user_id")
  isConfirmed Boolean    @default(true) @map("is_confirmed") // 是否已确认(AI记账需要)
  confidence  Float?     // AI解析置信度
  aiRawResponse String?  @map("ai_raw_response") // AI原始响应,用于调试
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  
  // 转账/还款场景: 目标账户
  targetAccountId String? @map("target_account_id")
  
  // 投资场景: 关联持仓
  investmentId    String? @map("investment_id")
  quantity        Float?  // 买卖数量
  unitPrice       Float?  @map("unit_price") // 单价
  
  // 信用卡场景: 关联信用卡
  creditCardId    String? @map("credit_card_id")
  cardIdentifier  String? @map("card_identifier") // 卡片标识

  // 关联关系
  account       Account?    @relation("SourceAccount", fields: [accountId], references: [id], onDelete: Cascade)
  targetAccount Account?    @relation("TargetAccount", fields: [targetAccountId], references: [id])
  investment    Investment? @relation(fields: [investmentId], references: [id])
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@index([accountId])
  @@index([targetAccountId])
  @@index([creditCardId])
  @@index([category])
  @@map("records")
}

// 记账类型常量 (SQLite不支持enum,使用String)
// EXPENSE = 支出
// INCOME = 收入
// TRANSFER = 转账

// =============================================
// 分类模型
// =============================================
model Category {
  id        String     @id @default(uuid())
  name      String     // 分类名称
  icon      String     // emoji或图标名
  type      String     // 支出/收入: EXPENSE, INCOME
  parentId  String?    @map("parent_id") // 父分类ID,支持二级分类
  userId    String?    @map("user_id") // null表示系统预设分类
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  // 关联关系
  user   User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent Category? @relation("CategoryChildren", fields: [parentId], references: [id])
  children Category[] @relation("CategoryChildren")

  @@index([userId])
  @@index([type])
  @@map("categories")
}

// =============================================
// 预算模型
// =============================================
model Budget {
  id          String   @id @default(uuid())
  month       String   // 格式: YYYY-MM
  category    String?  // 分类名称,null表示总预算
  name        String?  // 预算名称(用于区分同类预算)
  amount      Float    // 预算金额
  isRecurring Boolean  @default(false) @map("is_recurring") // 是否每月循环
  userId      String   @map("user_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month, category])
  @@index([userId, month])
  @@index([userId, isRecurring])
  @@map("budgets")
}

// =============================================
// 投资持仓模型 (阶段三功能)
// =============================================
model Investment {
  id            String   @id @default(uuid())
  name          String   // 投资标的名称,如:茅台股票、比特币
  type          String   // STOCK, FUND, CRYPTO
  code          String?  // 股票代码/基金代码
  costPrice     Float  @map("cost_price") // 成本价
  currentPrice  Float? @map("current_price") // 当前价格(用户手动更新)
  quantity      Float  // 持仓数量
  userId        String   @map("user_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // 关联记录
  records       Record[]

  @@index([userId])
  @@map("investments")
}

// =============================================
// AI 审计日志模型
// =============================================
model AIAuditLog {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  userRegion   String?  @map("user_region") // 用户区域: CN, US, EU, etc.
  provider     String   // AI Provider: Gemini, OpenAI, Qwen
  status       String   // SUCCESS, FAILURE
  durationMs   Int      @map("duration_ms") // 请求耗时(ms)
  errorMessage String?  @map("error_message") // 错误信息
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([provider, createdAt])
  @@map("ai_audit_logs")
}

// =============================================
// 定时任务模型 (支持工资、定期存款、订阅等场景)
// =============================================
model ScheduledTask {
  id          String   @id @default(uuid())
  name        String   // 任务名称,如: 工资、房租、Netflix订阅
  type        String   // INCOME 收入, EXPENSE 支出, TRANSFER 转账
  amount      Float    // 金额
  category    String   // 分类
  accountId   String   @map("account_id") // 关联账户
  userId      String   @map("user_id")
  
  // 调度配置
  frequency   String   // DAILY, WEEKLY, MONTHLY, YEARLY
  dayOfMonth  Int?     @map("day_of_month")  // 每月几号 (1-31)
  dayOfWeek   Int?     @map("day_of_week")   // 每周几 (0-6, 0=周日)
  monthOfYear Int?     @map("month_of_year") // 每年几月 (1-12)
  executeTime String   @default("09:00") @map("execute_time") // 执行时间 HH:mm
  
  // 有效期
  startDate   DateTime @map("start_date") // 开始日期
  endDate     DateTime? @map("end_date")  // 结束日期 (可选)
  
  // 状态
  isEnabled   Boolean  @default(true) @map("is_enabled")   // 是否启用
  lastRunAt   DateTime? @map("last_run_at") // 上次执行时间
  nextRunAt   DateTime? @map("next_run_at") // 下次执行时间
  runCount    Int      @default(0) @map("run_count") // 已执行次数
  
  description String?  // 备注
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([nextRunAt, isEnabled])
  @@map("scheduled_tasks")
}

// 定时任务执行日志
model ScheduledTaskLog {
  id        String   @id @default(uuid())
  taskId    String   @map("task_id")
  recordId  String?  @map("record_id") // 生成的记账记录ID
  status    String   // SUCCESS, FAILED
  message   String?  // 执行消息/错误信息
  executedAt DateTime @default(now()) @map("executed_at")
  
  @@index([taskId])
  @@map("scheduled_task_logs")
}

// =============================================
// 信用卡模型
// =============================================
model CreditCard {
  id               String   @id @default(uuid())
  name             String   // 卡片名称,如: 招商VISA卡
  institutionName  String   @map("institution_name") // 发卡银行
  cardIdentifier   String   @map("card_identifier") // 卡片标识(如尾号4位)
  creditLimit      Float    @default(0) @map("credit_limit") // 信用额度
  currentBalance   Float    @default(0) @map("current_balance") // 当前待还金额
  repaymentDueDate String?  @map("repayment_due_date") // 还款日(每月几号)
  currency         String   @default("CNY")
  userId           String   @map("user_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // 关联关系
  user         User @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions CreditCardTransaction[]
  autoPayments AutoPayment[]

  @@unique([userId, cardIdentifier])
  @@index([userId])
  @@map("credit_cards")
}

// =============================================
// 信用卡消费记录模型
// =============================================
model CreditCardTransaction {
  id            String     @id @default(uuid())
  creditCardId  String     @map("credit_card_id")
  amount        Float      // 消费金额（正数）
  type          String     // EXPENSE(消费) 或 PAYMENT(还款)
  category      String     // 消费分类
  description   String?    // 消费描述
  date          DateTime   @default(now())
  recordId      String?    @map("record_id") // 关联主记录表
  userId        String     @map("user_id")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // 关联关系
  creditCard CreditCard @relation(fields: [creditCardId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([creditCardId])
  @@index([userId])
  @@index([date])
  @@map("credit_card_transactions")
}

// 信用卡交易类型常量 (SQLite不支持enum,使用String)
// EXPENSE = 消费（增加待还）
// PAYMENT = 还款（减少待还）

// =============================================
// 自动扣款配置模型
// =============================================
model AutoPayment {
  id                String   @id @default(uuid())
  name              String   // 扣款名称: "招行信用卡还款", "房贷还款"
  
  // 扣款类型
  // CREDIT_CARD_FULL: 信用卡全额还款
  // CREDIT_CARD_MIN: 信用卡最低还款
  // LOAN: 贷款还款
  // MORTGAGE: 房贷还款
  // SUBSCRIPTION: 订阅扣款
  paymentType       String   @map("payment_type")
  
  // 关联目标 (二选一)
  creditCardId      String?  @map("credit_card_id")   // 关联信用卡
  liabilityAccountId String? @map("liability_account_id") // 关联贷款账户
  
  // 金额配置
  fixedAmount       Float?   @map("fixed_amount")      // 固定金额(贷款/订阅)
  // 信用卡还款时: null 表示动态获取当期账单金额
  
  // 调度配置
  dayOfMonth        Int      @map("day_of_month")      // 每月几号执行 (1-28)
  executeTime       String   @default("08:00") @map("execute_time") // 执行时间
  
  // 提前提醒
  reminderDaysBefore Int     @default(2) @map("reminder_days_before") // 提前几天提醒
  
  // 余额不足处理策略
  // NOTIFY: 仅通知用户
  // RETRY_NEXT_DAY: 第二天重试
  // PARTIAL_PAY: 部分还款(信用卡最低还款)
  // TRY_NEXT_SOURCE: 尝试下一个来源账户（多来源时使用）
  // SKIP: 跳过本次
  insufficientFundsPolicy String @default("TRY_NEXT_SOURCE") @map("insufficient_funds_policy")
  
  // 贷款进度跟踪
  totalPeriods      Int?     @map("total_periods")       // 总期数
  completedPeriods  Int      @default(0) @map("completed_periods") // 已还期数
  startDate         DateTime? @map("start_date")         // 开始日期
  
  // 状态
  isEnabled         Boolean  @default(true) @map("is_enabled")
  lastExecutedAt    DateTime? @map("last_executed_at")
  nextExecuteAt     DateTime? @map("next_execute_at")
  
  // 用户
  userId            String   @map("user_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // 关联
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  creditCard        CreditCard? @relation(fields: [creditCardId], references: [id], onDelete: SetNull)
  liabilityAccount  Account? @relation("PaymentTarget", fields: [liabilityAccountId], references: [id], onDelete: SetNull)
  logs              AutoPaymentLog[]
  sources           AutoPaymentSource[]  // 多个来源账户（按优先级排序）
  
  @@index([userId])
  @@index([nextExecuteAt, isEnabled])
  @@map("auto_payments")
}

// 自动扣款来源账户（支持多来源和优先级）
model AutoPaymentSource {
  id              String   @id @default(uuid())
  autoPaymentId   String   @map("auto_payment_id")
  accountId       String   @map("account_id")
  priority        Int      @default(1)  // 优先级: 1=最高优先
  
  // 关联
  autoPayment     AutoPayment @relation(fields: [autoPaymentId], references: [id], onDelete: Cascade)
  account         Account     @relation("AutoPaymentSources", fields: [accountId], references: [id], onDelete: Cascade)
  
  @@unique([autoPaymentId, accountId])  // 同一个扣款配置中每个账户只能出现一次
  @@index([autoPaymentId])
  @@map("auto_payment_sources")
}

// 自动扣款执行日志
model AutoPaymentLog {
  id              String   @id @default(uuid())
  autoPaymentId   String   @map("auto_payment_id")
  
  // 执行结果: SUCCESS, FAILED, INSUFFICIENT_FUNDS, PARTIAL, SKIPPED
  status          String
  amount          Float    // 实际扣款金额
  sourceBalance   Float?   @map("source_balance") // 执行时来源账户余额
  
  // 关联记录
  recordId        String?  @map("record_id") // 生成的记账记录
  
  message         String?  // 执行消息/错误信息
  executedAt      DateTime @default(now()) @map("executed_at")
  
  autoPayment     AutoPayment @relation(fields: [autoPaymentId], references: [id], onDelete: Cascade)

  @@index([autoPaymentId])
  @@map("auto_payment_logs")
}

// =============================================
// 自动入账配置模型
// =============================================
model AutoIncome {
  id                String   @id @default(uuid())
  name              String   // 入账名称: "工资", "公积金", "养老金"

  // 入账类型
  // SALARY: 工资
  // HOUSING_FUND: 公积金
  // PENSION: 养老金/退休金
  // RENTAL: 租金收入
  // INVESTMENT_RETURN: 投资收益
  // OTHER: 其他固定收入
  incomeType        String   @map("income_type")

  // 入账金额
  amount            Float

  // 入账目标账户
  targetAccountId   String   @map("target_account_id")

  // 分类
  category          String   @default("工资")

  // 调度配置
  dayOfMonth        Int      @map("day_of_month")       // 每月几号 (1-28)
  executeTime       String   @default("09:00") @map("execute_time")

  // 提前提醒
  reminderDaysBefore Int     @default(1) @map("reminder_days_before")

  // 状态
  isEnabled         Boolean  @default(true) @map("is_enabled")
  lastExecutedAt    DateTime? @map("last_executed_at")
  nextExecuteAt     DateTime? @map("next_execute_at")

  // 用户
  userId            String   @map("user_id")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // 关联
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetAccount     Account  @relation("IncomeTarget", fields: [targetAccountId], references: [id], onDelete: Cascade)
  logs              AutoIncomeLog[]

  @@index([userId])
  @@index([nextExecuteAt, isEnabled])
  @@map("auto_incomes")
}

// 自动入账类型常量 (SQLite不支持enum,使用String)
// SALARY = 工资
// HOUSING_FUND = 公积金
// PENSION = 养老金/退休金
// RENTAL = 租金收入
// INVESTMENT_RETURN = 投资收益
// OTHER = 其他固定收入

// =============================================
// 自动入账执行日志
// =============================================
model AutoIncomeLog {
  id              String   @id @default(uuid())
  autoIncomeId    String   @map("auto_income_id")
  status          String   // SUCCESS, SKIPPED
  amount          Float    // 入账金额
  recordId        String?  @map("record_id") // 生成的记账记录ID
  message         String?
  executedAt      DateTime @default(now()) @map("executed_at")

  autoIncome      AutoIncome @relation(fields: [autoIncomeId], references: [id], onDelete: Cascade)

  @@index([autoIncomeId])
  @@map("auto_income_logs")
}
